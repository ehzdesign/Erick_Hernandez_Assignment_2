window.app=window.app||{},window.lib=window.lib||{},function(){!function(t){var i,e=null;i=function(t){clearTimeout(e),setTimeout(t,20)},t.requestAnimationFrame=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||i}(window),$.sprintf=function(){var t=Array.prototype.slice.call(arguments);return t.shift().replace(/%s/g,function(){return t.shift()||""})},$.fn.serializeObject=function(){var t={};return this.serializeArray().forEach(function(i){return i.name in t?($.isArray(t[i.name])||(t[i.name]=[t[i.name]]),void t[i.name].push(i.value)):void(t[i.name]=i.value)}),t},$.support.localStorage="localStorage"in window}(),lib.Layout=$.Class({use:["events"],win:null,height:null,target:[],outside:[],initialized:!1,initialize:function(t){var i=this;this.win=$("body"),t.target.forEach(function(t){i.target.push($(t))}),t.outsize.forEach(function(t){i.outside.push($(t))}),this.process(),this.show()},show:function(){this.target.forEach(function(t){t.fadeIn()})},process:function(){var t=this;this.win.height()!==this.height&&(this.height=this.win.height(),this.target.forEach(function(i){var e=t.height;t.outside.forEach(function(t){e-=t.outerHeight()}),i.height(e)})),requestAnimationFrame(this.process.bind(this))}}),lib.Editor=$.Class({EVENT_FIRE:"fire",use:["events"],node:null,editor:null,initialize:function(t){this.node=$(t),this.editor=CodeMirror(this.node.get(0),{mode:"less",theme:"base16-light",indentUnit:4,tabSize:4}),this.refreshValue(),this.refreshConfig(),this.editor.on("keydown",this.onKeyUp.bind(this))},refreshValue:function(){this.editor.setValue(app.config.attr("value"))},refreshConfig:function(){this.editor.setOption("keyMap",app.config.attr("keyMap"))},onKeyUp:function(t,i){(i.ctrlKey||i.metaKey)&&13===i.keyCode&&this.trigger(this.EVENT_FIRE,{value:this.editor.getValue()})}}),lib.Compiler=$.Class({node:null,less:null,initialize:function(t){this.node=$(t),this.less=new less.Parser(null,{},{})},compile:function(t){var i=this;this.less.parse(t,function(t,e){return i.node.toggleClass("error",!!t),t?i.node.val("[ERROR] "+t.message):void i.node.val(e.toCSS({compress:"true"===app.config.attr("compress")}))})}}),lib.Dialog=$.Class({node:null,initialize:function(t){this.node=$(t),this.node.on("click",this.onClick.bind(this))},onClick:function(t){var i=$(t.currentTarget).data("dialog");$(i).dialog("open",{width:480})}}),lib.Config=$.Class({use:["events","attributes"],defaults:{attributes:{value:"// Input LESS here, strike 'Ctrl|Command+Enter' to compile.\n",keyMap:"default",compress:"false"}},node:null,initialize:function(t){this.node=$(t),this.fetch(),this.initForm(),this.node.on("change",this.onChange.bind(this)),this.node.on("submit",function(t){t.preventDefault()}),this.on("change",this.save.bind(this)),this.node.find("#button-config-reset").on("click",this.reset.bind(this))},fetch:function(){var t={};$.support.localStorage&&($.each(this.attributes,function(i){var e=localStorage.getItem(i);e&&(t[i]=e)}),this.attr(t),this.save())},initForm:function(){var t=this;["keyMap","compress"].forEach(function(i){t.node.find($.sprintf("[name=%s]",i)).filter($.sprintf("[value=%s]",t.attr(i))).prop("checked",!0)})},onChange:function(){this.attr(this.node.serializeObject()),app.editor&&app.editor.refreshConfig()},save:function(){$.support.localStorage&&$.each(this.attr(),function(t,i){localStorage.setItem(t,i)})},initDefault:function(){this.attr(this.defaults.attributes),this.save()},reset:function(){this.attr(this.defaults.attributes),this.save(),this.initForm(),app.editor.refreshConfig(),app.editor.refreshValue()}}),function(){app.layout=new lib.Layout({target:[".wdg-editor",".wdg-output"],outsize:[".wdg-head",".wdg-foot"]}),app.config=new lib.Config(".wdg-config"),app.editor=new lib.Editor(".wdg-editor"),app.compiler=new lib.Compiler(".wdg-output textarea"),app.dialog=new lib.Dialog("[data-dialog]"),app.editor.on("fire",function(t,i){app.compiler.compile(i.value),app.config.attr("value",i.value).save()})}();